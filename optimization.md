# WEb前端性能优化

## 常使用性能测试工具

雅虎的Yslow,相对而言，有对应的23条优化规则

## 描述

不论是网页还是其他，IO操作(次数，size，阻塞，带宽，延迟)和CPU的是影响性能的关键。对于网页而言，想要提高性能就要在IO操作上下功夫。



## 在地址栏输入url发生什么？

### 几个概念

1. url：统一资源定位符，是一个地址
2. 常见的url协议:http https ftp file
3. ip:网络层的主要协议，ip地址是主机号，一般分为IPv4和IPv6
4. 公网ip:国际互联网分配的唯一的IP地址，是个静态IP地址。
5. 内网ip:由路由器建立子网分配IP地址。
6. dns:域名解析，将域名映射到对应的ip，流程:
    1. 浏览器缓存 – 浏览器会缓存DNS记录一段时间
    2. 系统缓存 - 从 Hosts 文件查找是否有该域名和对应 IP。
    3. 路由器缓存 – 一般路由器也会缓存域名信息。
    4. ISP DNS 缓存 – 比如到电信的 DNS 上查找缓存。
    5. 如果都没有找到，则向根域名服务器查找域名对应 IP，根域名服务器把请求转发到下一级，直到找到 IP。
    6. dns劫持：将系统缓存host文件里的域名对应的IP改成其他IP，致使用户访问该域名是是访问到其他的网站。
7. tcp/ip协议（从上往下）:应用层(表示层，会话层)，传输层，网络层，数据链路层(物理层)     --> 发送端从上往下 ，接收端从下往上

### 流程

地址栏输入url -> 应用层dns解析（先本地缓存查找若有返回ip，若没有就向根域名服务器查找直到找到对应的ip）-> 应用层客户端向该ip服务器发起HTTP请求(包括请求报头（包括请求方法，协议，目标url,是否缓存等）和请求主体) ->传输层TCP传输报文（三次握手）->网络层IP协议查询MAC地址 -> 数据到达数据链路层 ->  服务器接受请求并处理响应 -> 服务器返回相应文件 -> 渲染(jiexiHTML以构建DOM树(标签) –> 构建渲染树（加入css和style样式） –> 布局渲染树 –> 绘制渲染树)

### 优化方式

1. 尽可能的减少 HTTP 的请求数 [content] 
```
减少http请求:使用精灵图(将页面上的背景图合并为一张,可以通过background-position来获取不同的背景图片),使用字体图标,合并css,js文件(可以开发时分开,在后台进行合并.对于首页可以把css和js写在html文件里),优化图片
```
2. 使用 CDN（Content Delivery Network） [server] (减少带宽)
```
在现有的internet外增加一层新的网络架构(cache服务器),将网站内容发布到最近用户的cache服务器上,通过DNS负载均衡技术,判断用户的来源然后在用户最近的cache服务器上取所需的内容,减少了在网络上传输时间
```
3. 添加 Expires头(或者 Cache-control ) [server] 
```
通过报文设置指定类型的文件在浏览器的缓存时间,可以从network的报头信息中看到
```
4. Gzip 组件 [server] 
```
在服务器上进行文件压缩,显著减少文件传输大小,一般压缩85%,在浏览器会进行解压,一般支持gzip格式,默认压缩HTML文件,若是其他文件需要配置,若不配置体积变大
```
5. 将 CSS 样式放在页面的上方 [css] 
```
如果把css样式放在底部,会导致重绘页面元素,重新生成渲染树添加到页面.这样会导致页面空白,给用户不好的体验
```
6. 将脚本移动到底部（包括内联的） [javascript] 
```
js会阻塞加载,并且有些需要页面加载完毕后才能执行js,所以把js放在底部
```
7. 避免使用 CSS 中的 Expressions [css] 
```
多了嵌套麻烦
```
8. 将 JavaScript 和 CSS 独立成外部文件 [javascript] [css]
```
方便维护和缓存,虽然多了2次请求
```
9. 减少 DNS 查询 [content]
```
域名好记但是需要通过DNS转换成ip地址,但是域名解析需要花费很多时间,所以可以设置缓存或者尽量控制域名个数减少DNS查询
```
10. 压缩 JavaScript 和 CSS (包括内联的) [javascript] [css]
```
本地压缩:比如减少字节数,或者类似于jquery的min版
```
11. 避免重定向 [server] 
```
每增加一次重定向就会多一次web请求
```
12. 移除重复的脚本 [javascript] 
13. 配置实体标签（ETags） [css] 
```
Etags:被请求变量的实体值,使用Etags可以减少带宽和负载,本质是服务器产生Etag返回给页面浏览器缓存,下次访问是会把Etag发送给服务器判断是否发生变化,若未修改返回304和空响应体
[实现](http://www.kuqin.com/web/20080513/8442.html)
```
14. 使 AJAX 缓存(尽量使用get方法):

```
数据缓存:使用redis
```

## 图片优化

### 使用base64代替图片

场景:适用于图片大小小于2kb,页面图片不是很多的情况

### 合并图片称精灵图

### 图片延迟加载

### 图片预加载

dns预加载:淘宝使用link引入资源,link上的rel:dns-perfetch

### 使用css、svg、canvas或iconfont代替图片

### 更好的图片格式(webP,bpg,sharpP)

## 图片加载优化

### 图片的预加载

